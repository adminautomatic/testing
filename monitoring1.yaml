---
- name: AWX-safe node resource monitoring - prepare controller
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Mark controller for reporting
      ansible.builtin.set_fact:
        is_monitoring_controller: true
      run_once: true

- name: Collect resource metrics on all nodes
  hosts: all
  become: true
  gather_facts: false
  vars:
    cpu_threshold: 80
    memory_threshold: 80
    disk_threshold: 80
    filesystem_threshold: 80
    k3s_storage_threshold_gb: 10
  tasks:
    - name: Get CPU usage safely
      ansible.builtin.shell: "top -bn1 | grep -i 'cpu(s)' | awk '{print 100 - $8}'"
      register: cpu_raw
      ignore_errors: true
      changed_when: false
      check_mode: false

    - name: Set CPU facts
      ansible.builtin.set_fact:
        cpu_used_pct: "{{ cpu_raw.stdout | float | default(0) }}"
        cpu_over_threshold: "{{ cpu_raw.stdout | float(default=0) > cpu_threshold }}"

    - name: Get memory usage safely
      ansible.builtin.shell: "free | awk '/^Mem:/ {printf \"%.1f\", ($3/$2)*100}'"
      register: mem_raw
      ignore_errors: true
      changed_when: false
      check_mode: false

    - name: Set memory facts
      ansible.builtin.set_fact:
        memory_used_pct: "{{ mem_raw.stdout | float | default(0) }}"
        memory_over_threshold: "{{ mem_raw.stdout | float(default=0) > memory_threshold }}"

    - name: Get filesystem usage safely
      ansible.builtin.shell: >
        df -hP | awk 'NR>1 && $1 !~ /^(tmpfs|devtmpfs|overlay)$/ && $NF !~ /^\/dev\/loop/ {print $NF " " $5}'
      register: fs_raw
      ignore_errors: true
      changed_when: false
      check_mode: false

    - name: Initialize filesystem_usage list
      ansible.builtin.set_fact:
        filesystem_usage: []

    - name: Append filesystem usage safely with threshold
      ansible.builtin.set_fact:
        filesystem_usage: "{{ filesystem_usage + [fs_entry] }}"
      vars:
        fs_parts: "{{ item.split() }}"
        fs_entry:
          mount: "{{ fs_parts[0] }}"
          usage: "{{ fs_parts[1] }}"
          usage_percent: "{{ (fs_parts[1].rstrip('%') | int) }}"
          over_threshold: "{{ (fs_parts[1].rstrip('%') | int) >= filesystem_threshold }}"
      loop: "{{ fs_raw.stdout_lines | default([]) }}"
      when: item.split() | length >= 2

    - name: Calculate max disk usage and fail flag
      ansible.builtin.set_fact:
        disk_percentages: >-
          {{ fs_raw.stdout_lines | default([])
             | map('split')
             | map('last')
             | map('regex_replace', '%', '')
             | map('int') | list }}
        disk_used_max_pct: "{{ disk_percentages | default([0]) | max }}"
        disk_over_threshold: "{{ (disk_percentages | default([0]) | max) > disk_threshold }}"

    - name: Get k3s containerd storage usage safely
      ansible.builtin.shell: "du -sx --block-size=1G /var/lib/rancher/k3s/agent/containerd 2>/dev/null | cut -f1 || echo 0"
      register: k3s_raw
      ignore_errors: true
      changed_when: false
      check_mode: false

    - name: Set k3s facts
      ansible.builtin.set_fact:
        k3s_storage_gb: "{{ k3s_raw.stdout | int | default(0) }}"
        k3s_over_threshold: "{{ (k3s_raw.stdout | int | default(0)) > k3s_storage_threshold_gb }}"

    - name: Build host monitoring summary
      ansible.builtin.set_fact:
        monitoring_summary:
          cpu: "{{ cpu_used_pct }}"
          memory: "{{ memory_used_pct }}"
          disk: "{{ disk_used_max_pct }}"
          k3s: "{{ k3s_storage_gb }}"
          failed: "{{ cpu_over_threshold or memory_over_threshold or disk_over_threshold or (filesystem_usage | selectattr('over_threshold') | list | length > 0) }}"

- name: Generate reports and fail if needed (controller only)
  hosts: localhost
  connection: local
  gather_facts: false
  run_once: true
  vars:
    # â”€â”€ Customize these â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    smtp_host: "smtp.ibm.com"               # â† your IBM SMTP server
    smtp_port: "587"                        # 587 = STARTTLS, 465 = SSL
    smtp_user: "your-ibm-username@ibm.com"  # â† change
    smtp_pass: "your-app-specific-password" # â† use ansible-vault in prod!
    smtp_from: "AWX-Monitoring <awx-monitoring@yourdomain.com>"
    recipient: "krishnakumar.subramanian@ibm.com"
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  tasks:
    - name: Display cluster resource summary
      ansible.builtin.debug:
        msg: |
          ## Cluster Resource Summary

          | Host                  | CPU % | Mem % | Disk % | k3s GB | Status |
          |:----------------------|------:|------:|-------:|-------:|--------|
          {% for host in groups['all'] | sort %}
          | {{ host | truncate(21) }} | {{ hostvars[host].monitoring_summary.cpu | default('n/a') }} | {{ hostvars[host].monitoring_summary.memory | default('n/a') }} | {{ hostvars[host].monitoring_summary.disk | default('n/a') }} | {{ hostvars[host].monitoring_summary.k3s | default('n/a') }} | {{ 'FAIL' if hostvars[host].monitoring_summary.failed | default(false) else 'OK' }} |
          {% endfor %}

    - name: Display detailed filesystem usage with warnings
      ansible.builtin.debug:
        msg: |
          ## Filesystem Usage per Host (warning if â‰¥ 80%)

          {% for host in groups['all'] | sort %}
          ### {{ host }}
          | Mount Point              | Usage  | Status |
          |:-------------------------|-------:|--------|
          {% for fs in hostvars[host].filesystem_usage | default([]) %}
          | {{ fs.mount | truncate(24) }} | {{ fs.usage }} | {{ 'âš ï¸ WARNING' if fs.over_threshold else 'OK' }} |
          {% else %}
          | (no data collected)      | â€”      | â€”      |
          {% endfor %}
          {% endfor %}

    - name: Collect failed hosts
      ansible.builtin.set_fact:
        failed_hosts: >-
          {{ hostvars
             | dict2items
             | selectattr('value.monitoring_summary.failed', 'defined')
             | selectattr('value.monitoring_summary.failed', 'equalto', true)
             | map(attribute='key')
             | list }}

    - name: Prepare email body (only when there are issues)
      ansible.builtin.set_fact:
        email_body: |
          Subject: [ALERT] Resource Thresholds Exceeded in Cluster

          Hello Krishna,

          The resource monitoring playbook detected issues on one or more nodes.

          Execution time: {{ ansible_date_time.iso8601 }}

          {{ lookup('template', 'cluster_summary.j2') | indent(0) }}

          {{ lookup('template', 'filesystem_details.j2') | indent(0) }}

          Failed nodes:
          â€¢ {{ failed_hosts | join('\nâ€¢ ') | default('none') }}

          Please investigate promptly.

          Regards,
          AWX Monitoring
      when: failed_hosts | length > 0

    # Optional: Save body to file for debugging
    # - name: Save email body to /tmp for debug
    #   ansible.builtin.copy:
    #     content: "{{ email_body }}"
    #     dest: /tmp/monitoring-alert.txt
    #   when: failed_hosts | length > 0

    - name: Send email alert using msmtp (only if thresholds exceeded)
      ansible.builtin.shell: |
        echo "{{ email_body }}" | \
        ctr -n k8s.io run --rm \
          --mount type=bind,source=/tmp,target=/tmp \
          --mount type=bind,source=/dev/null,target=/dev/null \
          docker.io/library/awx-ee-msmtp:latest msmtp-run \
          msmtp \
            --host={{ smtp_host }} \
            --port={{ smtp_port }} \
            --auth=on \
            --tls=on \
            --tls-starttls=on \
            --user={{ smtp_user }} \
            --passwordeval="echo '{{ smtp_pass }}'" \
            --from={{ smtp_from }} \
            {{ recipient }}
      args:
        executable: /bin/bash
      changed_when: false
      failed_when: false  # don't fail whole playbook if email fails
      when: failed_hosts | length > 0

    - name: Fail the playbook if any node exceeds thresholds
      ansible.builtin.fail:
        msg: |
          ğŸš¨ Resource thresholds exceeded on the following nodes:

          â€¢ {{ failed_hosts | join('\nâ€¢ ') | default('none') }}
      when: failed_hosts | length > 0
