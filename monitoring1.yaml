---
- name: Monitor CPU, Memory, Disk, Filesystems, and K3s Storage on Nodes
  hosts: all
  become: yes
  gather_facts: no

  vars:
    cpu_threshold: 80
    memory_threshold: 80
    disk_threshold: 80
    k3s_storage_threshold_gb: 10

  tasks:

    ######################
    # CPU
    ######################

    - name: Get CPU usage
      shell: top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}'
      register: cpu_usage
      changed_when: false

    - name: Normalize CPU
      set_fact:
        cpu_used: "{{ cpu_usage.stdout | float }}"
        cpu_status: "{{ 'ðŸ”´ FAIL' if cpu_used > cpu_threshold else 'ðŸŸ¢ OK' }}"


    ######################
    # MEMORY
    ######################

    - name: Get memory usage
      shell: free | awk '/Mem:/ { printf("%.2f"), $3/$2 * 100 }'
      register: memory_usage
      changed_when: false

    - name: Normalize memory
      set_fact:
        memory_used: "{{ memory_usage.stdout | float }}"
        memory_status: "{{ 'ðŸ”´ FAIL' if memory_used > memory_threshold else 'ðŸŸ¢ OK' }}"


    ######################
    # FILESYSTEMS + DISK
    ######################

    - name: Get filesystem usage (all real mounts)
      shell: |
        df -hP --output=target,pcent -x tmpfs -x devtmpfs -x overlay -x squashfs | tail -n +2
      register: filesystem_usage
      changed_when: false

    - name: Normalize filesystem usage
      set_fact:
        filesystems: >-
          {{
            filesystem_usage.stdout_lines
            | map('split')
            | map('list')
            | map('community.general.dict', ['mount', 'usage'])
            | list
          }}

    - name: Calculate max disk usage
      set_fact:
        disk_used_max: >-
          {{
            filesystem_usage.stdout_lines
            | map('regex_replace', '^.*\\s+([0-9]+)%$', '\\1')
            | map('int')
            | max
            | default(0)
          }}
        disk_status: "{{ 'ðŸ”´ FAIL' if disk_used_max > disk_threshold else 'ðŸŸ¢ OK' }}"


    ######################
    # K3s STORAGE
    ######################

    - name: Get K3s containerd storage usage (GB)
      shell: du -s --block-size=1G /var/lib/rancher/k3s/agent/containerd 2>/dev/null | awk '{print $1}' || echo 0
      register: k3s_storage_raw
      changed_when: false

    - name: Normalize K3s storage
      set_fact:
        k3s_storage_gb: "{{ k3s_storage_raw.stdout | int }}"
        k3s_status: "{{ 'ðŸ”´ FAIL' if k3s_storage_gb > k3s_storage_threshold_gb else 'ðŸŸ¢ OK' }}"


    ######################
    # HOST SUMMARY
    ######################

    - name: Save host monitoring summary
      set_fact:
        monitoring_summary:
          cpu: "{{ '%.1f' | format(cpu_used) }}"
          memory: "{{ '%.1f' | format(memory_used) }}"
          disk: "{{ disk_used_max }}"
          k3s: "{{ k3s_storage_gb }}"
          status: >-
            {{
              'ðŸ”´ FAIL'
              if 'FAIL' in [cpu_status, memory_status, disk_status, k3s_status]
              else 'ðŸŸ¢ OK'
            }}


    ######################
    # CONSOLIDATED REPORTS
    ######################

    - name: Display cluster resource summary
      run_once: true
      delegate_to: localhost
      debug:
        msg: |
          ## ðŸ“Š K3s Cluster Resource Usage Summary

          | Hostname | CPU % | MEM % | Max Disk % | K3s GB | Status |
          |----------|-------|-------|------------|--------|--------|
          {% for host in groups['all'] %}
          | {{ host }} | {{ hostvars[host].monitoring_summary.cpu }} | {{ hostvars[host].monitoring_summary.memory }} | {{ hostvars[host].monitoring_summary.disk }} | {{ hostvars[host].monitoring_summary.k3s }} | {{ hostvars[host].monitoring_summary.status }} |
          {% endfor %}

    - name: Display filesystem usage per host
      run_once: true
      delegate_to: localhost
      debug:
        msg: |
          ## ðŸ’½ Filesystem Usage by Host

          {% for host in groups['all'] %}
          ### ðŸ–¥ï¸ {{ host }}

          | Mount | Usage |
          |-------|-------|
          {% for fs in hostvars[host].filesystems %}
          | {{ fs.mount }} | {{ fs.usage }} |
          {% endfor %}

          {% endfor %}


    ######################
    # FINAL FAIL (AWX-SAFE)
    ######################

    - name: Initialize failed hosts list
      run_once: true
      delegate_to: localhost
      set_fact:
        failed_hosts: []

    - name: Collect failed hosts
      run_once: true
      delegate_to: localhost
      set_fact:
        failed_hosts: "{{ failed_hosts + [item] }}"
      loop: "{{ groups['all'] }}"
      when: hostvars[item].monitoring_summary.status == 'ðŸ”´ FAIL'

    - name: Fail play if any host exceeded thresholds
      run_once: true
      delegate_to: localhost
      fail:
        msg: |
          ðŸš¨ One or more hosts exceeded resource thresholds.

          Failed hosts:
          {{ failed_hosts | join(', ') }}
      when: failed_hosts | length > 0
