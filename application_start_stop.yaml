---
########################
# ORACLE (MULTI-SID)
########################
- name: ORACLE | {{ action | upper }}
  hosts: oracle
  become: yes
  become_user: oradba
  serial: 1

  vars:
    oracle_home: /home/oradba/app/oradba/product/19.0.0/dbhome_1
    oracle_sids:
      - CLMINST
      - LDXDB

  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    PATH: "{{ oracle_home }}/bin:{{ ansible_env.PATH }}"

  tasks:
    - name: Oracle | Check status for each SID
      shell: |
        export ORACLE_SID={{ item }}
        echo "SID={{ item }}"
        ps -ef | grep ora_pmon_{{ item }} | grep -v grep || true
      loop: "{{ oracle_sids }}"
      register: oracle_status
      changed_when: false

    - name: Oracle | Start databases
      shell: |
        export ORACLE_SID={{ item.item }}
        sqlplus / as sysdba <<EOF
        startup;
        exit;
        EOF
      loop: "{{ oracle_status.results }}"
      when:
        - action == "start"
        - item.stdout is search("SID=")
        - item.stdout is not search("ora_pmon")

    - name: Oracle | Stop databases
      shell: |
        export ORACLE_SID={{ item }}
        sqlplus / as sysdba <<EOF
        shutdown immediate;
        exit;
        EOF
      loop: "{{ oracle_sids }}"
      when: action == "stop"

    - name: Oracle | Validate databases
      shell: |
        export ORACLE_SID={{ item }}
        sqlplus -s / as sysdba <<EOF
        SET HEADING OFF FEEDBACK OFF
        SELECT open_mode FROM v\$database;
        EXIT;
        EOF
      loop: "{{ oracle_sids }}"
      register: oracle_validate
      failed_when: oracle_validate.stdout is not search("READ WRITE")
      when: action == "start"

########################
# JAS
########################
- name: JAS | {{ action | upper }}
  hosts: jas
  become: yes
  serial: 1

  tasks:
    - name: Check JAS
      shell: ps -ef | grep java | grep jazz | grep -v grep || true
      register: jas_status
      changed_when: false

    - name: Start JAS
      shell: /opt/IBM/JazzAuthServer/start-jazz
      when:
        - action == "start"
        - jas_status.stdout == ""

    - name: Stop JAS
      shell: /opt/IBM/JazzAuthServer/stop-jazz || true
      when: action == "stop"

    - name: Validate JAS
      shell: ps -ef | grep java | grep jazz | grep -v grep
      register: jas_validate
      failed_when: jas_validate.stdout == ""
      when: action == "start"

########################
# APPLICATION
########################
- name: APPLICATION | {{ action | upper }}
  hosts: app
  become: yes
  serial: 1

  tasks:
    - name: Check Application
      shell: ps -ef | grep java | grep app | grep -v grep || true
      register: app_status
      changed_when: false

    - name: Start Application
      shell: /opt/IBM/JazzTeamServer/server/server.startup
      when:
        - action == "start"
        - app_status.stdout == ""

    - name: Stop Application
      shell: /opt/IBM/JazzTeamServer/server/server.shutdown || true
      when: action == "stop"

    - name: Validate Application
      shell: ps -ef | grep java | grep app | grep -v grep
      register: app_validate
      failed_when: app_validate.stdout == ""
      when: action == "start"

########################
# JTS (LAST ON START)
########################
- name: JTS | {{ action | upper }}
  hosts: jts
  become: yes
  serial: 1

  tasks:
    - name: Check JTS
      shell: ps -ef | grep java | grep jts | grep -v grep || true
      register: jts_status
      changed_when: false

    - name: Start JTS
      shell: /opt/IBM/JazzTeamServer/server/server.startup
      when:
        - action == "start"
        - jts_status.stdout == ""

    - name: Stop JTS
      shell: /opt/IBM/JazzTeamServer/server/server.shutdown || true
      when: action == "stop"

    - name: Validate JTS
      shell: ps -ef | grep java | grep jts | grep -v grep
      register: jts_validate
      failed_when: jts_validate.stdout == ""
      when: action == "start"

########################
# IHS
########################
- name: IHS | {{ action | upper }}
  hosts: ihs
  become: yes
  serial: 1

  tasks:
    - name: Check IHS
      shell: ps -ef | grep httpd | grep -v grep || true
      register: ihs_status
      changed_when: false

    - name: Start IHS
      shell: /opt/IBM/HTTPServer/bin/apachectl -k start
      when:
        - action == "start"
        - ihs_status.stdout == ""

    - name: Stop IHS
      shell: /opt/IBM/HTTPServer/bin/apachectl -k stop || true
      when: action == "stop"

    - name: Validate IHS
      shell: ps -ef | grep httpd | grep -v grep
      register: ihs_validate
      failed_when: ihs_validate.stdout == ""
      when: action == "start"

########################
# NOTIFICATION
########################
- name: NOTIFY | {{ action | upper }} RESULT
  hosts: localhost
  gather_facts: no

  tasks:
    - debug:
        msg: |
          ✅ Action: {{ action | upper }}
          ✔ Oracle (CLMINST, LDXDB) handled
          ✔ JAS, APP, JTS, IHS idempotent
          ✔ Start/Stop order enforced
          ✔ Validation successful
