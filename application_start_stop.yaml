---
###############################################################################
# ORACLE
###############################################################################
- name: ORACLE | {{ action | upper }}
  hosts: oracle
  become: yes
  become_user: oradba
  serial: 1

  vars:
    oracle_home: /home/oradba/app/oradba/product/19.0.0/dbhome_1
    oracle_sids:
      - CLMINST
      - LDXDB

  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    PATH: "{{ oracle_home }}/bin:{{ ansible_env.PATH }}"

  tasks:
    - name: Check Oracle PMON
      shell: ps -ef | grep "ora_pmon_{{ item }}" | grep -v grep || true
      loop: "{{ oracle_sids }}"
      register: oracle_status
      changed_when: false

    - name: Start Oracle DBs
      shell: |
        export ORACLE_SID={{ item }}
        sqlplus / as sysdba <<EOF
        startup;
        exit;
        EOF
      loop: "{{ oracle_sids }}"
      when:
        - action == "start"
        - oracle_status.results[loop.index0].stdout == ""

    - name: Stop Oracle DBs
      shell: |
        export ORACLE_SID={{ item }}
        sqlplus / as sysdba <<EOF
        shutdown immediate;
        exit;
        EOF
      loop: "{{ oracle_sids }}"
      when: action == "stop"

###############################################################################
# JAS (JazzAuthServer)
###############################################################################
- name: JAS | {{ action | upper }}
  hosts: jas
  become: yes
  become_user: root
  serial: 1

  vars:
    jas_home: /opt/IBM/JazzAuthServer

  tasks:
    - name: Check JAS JVM
      shell: ps -ef | grep ws-server.jar | grep jazzop | grep -v grep || true
      register: jas_status
      changed_when: false

    - name: Start JAS (detached)
      shell: |
        cd {{ jas_home }}
        nohup ./start-jazz > /tmp/jas_start.log 2>&1 &
      args:
        executable: /bin/bash
      when:
        - action == "start"
        - jas_status.stdout == ""

    - name: Stop JAS
      shell: |
        cd {{ jas_home }}
        ./stop-jazz || true
      when: action == "stop"

    - name: Pause for JAS initialization
      pause:
        seconds: 30
      when: action == "start"

    - name: Validate JAS
      uri:
        url: https://{{ inventory_hostname }}:9643/oidc/endpoint/jazzop
        validate_certs: no
        follow_redirects: all
        status_code: 200
      retries: 12        # 2 minutes
      delay: 10
      register: jas_check
      until: jas_check.status == 200
      when: action == "start"

###############################################################################
# APPLICATION (DCC + LQE)
###############################################################################
- name: APPLICATION | {{ action | upper }}
  hosts: app
  become: yes
  serial: 1

  vars:
    app_home: /opt/IBM/JazzTeamServer/server

  tasks:
    - name: Check App JVM
      shell: ps -ef | grep JazzTeamServer | grep -v grep || true
      register: app_status
      changed_when: false

    - name: Start App (DCC / LQE)
      shell: |
        cd {{ app_home }}
        nohup ./server.startup > /tmp/app_start.log 2>&1 &
      args:
        executable: /bin/bash
      when:
        - action == "start"
        - app_status.stdout == ""

    - name: Stop App (DCC / LQE)
      shell: |
        cd {{ app_home }}
        ./server.shutdown || true
      when: action == "stop"

    - name: Pause for App initialization
      pause:
        seconds: 30
      when: action == "start"

    - name: Validate App (safe)
      uri:
        url: "https://{{ inventory_hostname }}:9443/{{ item }}/"
        validate_certs: no
        follow_redirects: all
        status_code: 200
      loop:
        - dcc
        - lqe
      retries: 12
      delay: 10
      register: app_check
      until: app_check.status == 200
      when: action == "start"

###############################################################################
# JTS
###############################################################################
- name: JTS | {{ action | upper }}
  hosts: jts
  become: yes
  serial: 1

  vars:
    jts_home: /opt/IBM/JazzTeamServer/server

  tasks:
    - name: Check JTS JVM
      shell: ps -ef | grep JazzTeamServer | grep -v grep || true
      register: jts_status
      changed_when: false

    - name: Start JTS
      shell: |
        cd {{ jts_home }}
        nohup ./server.startup > /tmp/jts_start.log 2>&1 &
      args:
        executable: /bin/bash
      when:
        - action == "start"
        - jts_status.stdout == ""

    - name: Stop JTS
      shell: |
        cd {{ jts_home }}
        ./server.shutdown || true
      when: action == "stop"

    - name: Pause for JTS initialization
      pause:
        seconds: 30
      when: action == "start"

    - name: Validate JTS
      uri:
        url: https://{{ inventory_hostname }}:9443/jts/
        validate_certs: no
        follow_redirects: all
        status_code: 200
      retries: 12
      delay: 10
      register: jts_check
      until: jts_check.status == 200
      when: action == "start"

###############################################################################
# IHS
###############################################################################
- name: IHS | {{ action | upper }}
  hosts: ihs
  become: yes
  serial: 1

  tasks:
    - name: Check IHS
      shell: ps -ef | grep httpd | grep -v grep || true
      register: ihs_status
      changed_when: false

    - name: Start IHS
      shell: /opt/IBM/HTTPServer/bin/apachectl -k start
      when:
        - action == "start"
        - ihs_status.stdout == ""

    - name: Stop IHS
      shell: /opt/IBM/HTTPServer/bin/apachectl -k stop || true
      when: action == "stop"

###############################################################################
# FINAL STATUS
###############################################################################
- name: FINAL STATUS
  hosts: localhost
  gather_facts: no
  tasks:
    - debug:
        msg: |
          ✅ Action {{ action | upper }} completed
          ✔ Oracle
          ✔ JAS
          ✔ Application (DCC/LQE)
          ✔ JTS
          ✔ IHS
