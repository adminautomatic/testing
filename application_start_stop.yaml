########################
# ORACLE (CLMINST + LDXDB)
########################
- name: ORACLE | {{ action | upper }}
  hosts: oracle
  become: yes
  become_user: oradba
  serial: 1

  vars:
    oracle_home: /home/oradba/app/oradba/product/19.0.0/dbhome_1
    oracle_sids:
      - CLMINST
      - LDXDB

  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    PATH: "{{ oracle_home }}/bin:{{ ansible_env.PATH }}"

  tasks:
    - name: Check Oracle PMON
      shell: |
        for SID in {{ oracle_sids | join(' ') }}; do
          ps -ef | grep "ora_pmon_$SID" | grep -v grep || true
        done
      register: oracle_status
      changed_when: false

    - name: Start Oracle DBs
      shell: |
        export ORACLE_SID={{ item }}
        sqlplus / as sysdba <<EOF
        startup;
        exit;
        EOF
      loop: "{{ oracle_sids }}"
      when:
        - action == "start"
        - oracle_status.stdout is not search("ora_pmon_{{ item }}")

    - name: Stop Oracle DBs
      shell: |
        export ORACLE_SID={{ item }}
        sqlplus / as sysdba <<EOF
        shutdown immediate;
        exit;
        EOF
      loop: "{{ oracle_sids }}"
      when:
        - action == "stop"
        - oracle_status.stdout is search("ora_pmon_{{ item }}")

    - name: Wait for Oracle stop
      shell: |
        for SID in {{ oracle_sids | join(' ') }}; do
          while ps -ef | grep "ora_pmon_$SID" | grep -v grep; do sleep 5; done
        done
      when: action == "stop"

########################
# JAS
########################
- name: JAS | {{ action | upper }}
  hosts: jas
  become: yes
  serial: 1

  tasks:
    - name: Check JAS
      shell: ps -ef | grep java | grep JazzAuthServer | grep -v grep || true
      register: jas_status
      changed_when: false

    - name: Start JAS
      shell: /opt/IBM/JazzAuthServer/start-jazz
      when:
        - action == "start"
        - jas_status.stdout == ""

    - name: Stop JAS
      shell: /opt/IBM/JazzAuthServer/stop-jazz || true
      when:
        - action == "stop"
        - jas_status.stdout != ""

    - name: Wait for JAS start
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 9643
        state: started
        delay: 5
        timeout: 300
      when: action == "start"

    - name: Wait for JAS stop
      wait_for:
        port: 9643
        state: stopped
        delay: 5
        timeout: 300
      when: action == "stop"

########################
# APPLICATION (DCC + LQE)
########################
- name: APPLICATION | {{ action | upper }}
  hosts: app
  become: yes
  serial: 1

  tasks:
    - name: Check App JVM
      shell: ps -ef | grep java | grep JazzTeamServer | grep -v grep || true
      register: app_status
      changed_when: false

    #####################
    # START
    #####################
    - name: Start App
      shell: /opt/IBM/JazzTeamServer/server/server.startup
      when:
        - action == "start"
        - app_status.stdout == ""

    - name: Wait for App start (DCC/LQE) if just started
      uri:
        url: "https://{{ inventory_hostname }}:9443/{{ item }}/"
        validate_certs: no
        follow_redirects: all
        status_code: 200
      retries: 40
      delay: 15
      register: app_check
      until: app_check.status == 200
      loop:
        - dcc
        - lqe
      when:
        - action == "start"
        - app_status.stdout == ""  # Only wait if we just started the JVM

    - name: Validate App (DCC/LQE) if already running
      uri:
        url: "https://{{ inventory_hostname }}:9443/{{ item }}/"
        validate_certs: no
        follow_redirects: all
        status_code: 200
      retries: 10
      delay: 10
      register: app_check
      until: app_check.status == 200
      loop:
        - dcc
        - lqe
      when:
        - action == "start"
        - app_status.stdout != ""  # Only validate if already running

    #####################
    # STOP
    #####################
    - name: Stop App
      shell: /opt/IBM/JazzTeamServer/server/server.shutdown || true
      when:
        - action == "stop"
        - app_status.stdout != ""

    - name: Wait for App stop (DCC/LQE)
      wait_for:
        port: 9443
        state: stopped
        delay: 10
        timeout: 600
      when: action == "stop"

########################
# JTS
########################
- name: JTS | {{ action | upper }}
  hosts: jts
  become: yes
  serial: 1

  tasks:
    - name: Check JTS JVM
      shell: ps -ef | grep java | grep JazzTeamServer | grep -v grep || true
      register: jts_status
      changed_when: false

    - name: Start JTS
      shell: /opt/IBM/JazzTeamServer/server/server.startup
      when:
        - action == "start"
        - jts_status.stdout == ""

    - name: Stop JTS
      shell: /opt/IBM/JazzTeamServer/server/server.shutdown || true
      when:
        - action == "stop"
        - jts_status.stdout != ""

    - name: Wait for JTS start
      uri:
        url: "https://{{ inventory_hostname }}:9443/jts/"
        validate_certs: no
        follow_redirects: all
        status_code: 200
      retries: 30
      delay: 15
      register: jts_check
      until: jts_check.status == 200
      when: action == "start"

    - name: Wait for JTS stop
      wait_for:
        port: 9443
        state: stopped
        delay: 10
        timeout: 600
      when: action == "stop"

########################
# IHS
########################
- name: IHS | {{ action | upper }}
  hosts: ihs
  become: yes
  serial: 1

  tasks:
    - name: Check IHS
      shell: ps -ef | grep httpd | grep -v grep || true
      register: ihs_status
      changed_when: false

    - name: Start IHS
      shell: /opt/IBM/HTTPServer/bin/apachectl -k start
      when:
        - action == "start"
        - ihs_status.stdout == ""

    - name: Stop IHS
      shell: /opt/IBM/HTTPServer/bin/apachectl -k stop || true
      when:
        - action == "stop"
        - ihs_status.stdout != ""

    - name: Wait for IHS start
      wait_for:
        port: 80
        state: started
        delay: 5
        timeout: 300
      when: action == "start"

    - name: Wait for IHS stop
      wait_for:
        port: 80
        state: stopped
        delay: 5
        timeout: 300
      when: action == "stop"

########################
# FINAL NOTIFICATION
########################
- name: NOTIFY | {{ action | upper }} RESULT
  hosts: localhost
  gather_facts: no

  tasks:
    - debug:
        msg: |
          âœ… Action: {{ action | upper }}
          {% if action == "start" %}
          âœ” Oracle healthy
          âœ” JAS healthy
          âœ” DCC/LQE running
          âœ” JTS running
          âœ” IHS ready
          ðŸŽ‰ Environment is UP
          {% else %}
          âœ” Oracle stopped
          âœ” JAS stopped
          âœ” DCC/LQE stopped
          âœ” JTS stopped
          âœ” IHS stopped
          ðŸŽ‰ Environment is DOWN
          {% endif %}
